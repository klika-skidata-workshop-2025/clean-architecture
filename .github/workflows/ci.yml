name: CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  build-shared-libraries:
    name: Build Shared Libraries
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create local packages directory
      run: mkdir -p local-packages

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore Workshop.Common
      run: dotnet restore src/Shared/Workshop.Common/Workshop.Common.csproj

    - name: Build Workshop.Common
      run: dotnet build src/Shared/Workshop.Common/Workshop.Common.csproj --configuration Release --no-restore

    - name: Test Workshop.Common
      run: dotnet test src/Shared/Workshop.Common/Workshop.Common.csproj --configuration Release --no-build --verbosity normal
      continue-on-error: true

    - name: Restore Workshop.Proto
      run: dotnet restore src/Shared/Workshop.Proto/Workshop.Proto.csproj

    - name: Build Workshop.Proto
      run: dotnet build src/Shared/Workshop.Proto/Workshop.Proto.csproj --configuration Release --no-restore

    - name: Restore Workshop.Messaging
      run: dotnet restore src/Shared/Workshop.Messaging/Workshop.Messaging.csproj

    - name: Build Workshop.Messaging
      run: dotnet build src/Shared/Workshop.Messaging/Workshop.Messaging.csproj --configuration Release --no-restore

    - name: Pack NuGet packages to local feed
      run: |
        mkdir -p local-packages
        dotnet pack src/Shared/Workshop.Common/Workshop.Common.csproj --configuration Release --no-build --output ./local-packages
        dotnet pack src/Shared/Workshop.Proto/Workshop.Proto.csproj --configuration Release --no-build --output ./local-packages
        dotnet pack src/Shared/Workshop.Messaging/Workshop.Messaging.csproj --configuration Release --no-build --output ./local-packages

    - name: Upload NuGet packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./local-packages/*.nupkg
        retention-days: 7

  build-device-service:
    name: Build Device Service
    runs-on: ubuntu-latest
    needs: build-shared-libraries

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./local-packages

    - name: Restore dependencies
      run: dotnet restore src/Services/DeviceService/DeviceService.API/DeviceService.API.csproj

    - name: Build
      run: dotnet build src/Services/DeviceService/DeviceService.API/DeviceService.API.csproj --configuration Release --no-restore

    - name: Test
      run: dotnet test src/Services/DeviceService/DeviceService.Application.Tests/DeviceService.Application.Tests.csproj --configuration Release --verbosity normal
      continue-on-error: true

  build-monitoring-service:
    name: Build Monitoring Service
    runs-on: ubuntu-latest
    needs: build-shared-libraries

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./local-packages

    - name: Restore dependencies
      run: dotnet restore src/Services/MonitoringService/MonitoringService.API/MonitoringService.API.csproj

    - name: Build
      run: dotnet build src/Services/MonitoringService/MonitoringService.API/MonitoringService.API.csproj --configuration Release --no-restore

    - name: Test
      run: dotnet test src/Services/MonitoringService/MonitoringService.Application.Tests/MonitoringService.Application.Tests.csproj --configuration Release --verbosity normal
      continue-on-error: true

  build-diagnostics-service:
    name: Build Diagnostics Service
    runs-on: ubuntu-latest
    needs: build-shared-libraries

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./local-packages

    - name: Restore dependencies
      run: dotnet restore src/Services/DiagnosticsService/DiagnosticsService.API/DiagnosticsService.API.csproj

    - name: Build
      run: dotnet build src/Services/DiagnosticsService/DiagnosticsService.API/DiagnosticsService.API.csproj --configuration Release --no-restore

  build-orchestrator:
    name: Build Orchestrator
    runs-on: ubuntu-latest
    needs: build-shared-libraries

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download NuGet packages
      uses: actions/download-artifact@v4
      with:
        name: nuget-packages
        path: ./local-packages

    - name: Restore dependencies
      run: dotnet restore src/Orchestrator/Workshop.Orchestrator/Workshop.Orchestrator.csproj

    - name: Build
      run: dotnet build src/Orchestrator/Workshop.Orchestrator/Workshop.Orchestrator.csproj --configuration Release --no-restore

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-device-service, build-monitoring-service, build-diagnostics-service, build-orchestrator]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Device Service image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/Services/DeviceService/Dockerfile
        push: false
        tags: workshop/device-service:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build Monitoring Service image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/Services/MonitoringService/Dockerfile
        push: false
        tags: workshop/monitoring-service:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build Diagnostics Service image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/Services/DiagnosticsService/Dockerfile
        push: false
        tags: workshop/diagnostics-service:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build Orchestrator image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/Orchestrator/Workshop.Orchestrator/Dockerfile
        push: false
        tags: workshop/orchestrator:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
